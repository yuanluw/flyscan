/***************************************************************************************************
  * 文 件 名: angle_core.c
  * 作    者：罗民
  *	日    期：2014/7/13
  * 版    本：V1.0
  * 开 发 板：TM4C123G6PZ--实验开发板
  * 修改时间：无 
  * 编 译 器: keil.4.54
  *-------------------------------------------------------------------------------------------------
  * 简    介:
  * 参    考:
  *	笔记名称:
  * 注    意：
  *************************************************************************************************/  
/*--------包含头文件------------------------------------------------------------------------------*/
#include "angle_core.h"
#include "Fly_Math.h"
/**************************************************************************************************/
/*--------变量的定义-------------------------------------------------------------------------------*/

/**************************************************************************************************/
/*--------结构体的定义-------------------------------------------------------------------------------*/

/**************************************************************************************************/
/*-------进口函数----------------------------------------------------------------------------------*/

/**************************************************************************************************/
/*--------函数模型----------------------------------------------------------------------------------*/

typedef struct
{
	volatile float X;
	volatile float Y;
	volatile float Z;
}Vector_Typedef;

volatile Vector_Typedef Pre_V;
volatile Vector_Typedef Now_V;
volatile Vector_Typedef Temp_V;
float Acc_Gyro_Add=0.0002;
/**************************************************************************************************/
/*-------进口函数----------------------------------------------------------------------------------*/

/**************************************************************************************************/
/*--------函数模型----------------------------------------------------------------------------------*/
//------------------------------------------------------------------------------------------------
//  & 函数名： 位姿数据初始化函数
//  & 参  数： 无
//  & 返  回： 无
//  ---------------------------------------------------------------------------------------------
//  & 说  明： 无
//------------------------------------------------------------------------------------------------
void Position_DataInit(float PreV_Z)
{
	Pre_V.X=0;
	Pre_V.Y=0;
	Pre_V.Z=PreV_Z;
	
	Now_V.X=0;
	Now_V.Y=0;
	Now_V.Z=0;
	
	Temp_V.X=0;
	Temp_V.Y=0;
	Temp_V.Z=0;
}

//------------------------------------------------------------------------------------------------
//  & 函数名： 姿态角的获取
//  & 参  数： 无
//  & 返  回： 无
//  ---------------------------------------------------------------------------------------------
//  & 说  明： 无
//------------------------------------------------------------------------------------------------
uint8_t df_i;
float fsind[3];
float fcosd[3];
void Get_Angle(volatile Angle_Typedef *Pos,volatile MPU6050_Typedef* Mpu_6050)
{
	// 获取6050数据
 	Get_MPU6050_FilterAfter_Data(Mpu_6050);


	for(df_i=0;df_i<3;df_i++)
	{
		fsind[df_i] = _6050fsin(Mpu_6050->Gyro_Data[df_i]);
		fcosd[df_i] = _6050fcos(Mpu_6050->Gyro_Data[df_i]);
	}
		
	Temp_V.X = Pre_V.X*fcosd[0]*fcosd[2];
	Temp_V.X += Pre_V.Y*fsind[0]*fsind[1]*fcosd[2];
	Temp_V.X += Pre_V.Z*fcosd[1]*fsind[0]*fcosd[2];
	Temp_V.X -= Pre_V.Y*fcosd[1]*fsind[2];
	Temp_V.X += Pre_V.Z*fsind[1]*fsind[2];
	
	Temp_V.Y = Pre_V.X*fcosd[0]*fsind[2];
	Temp_V.Y += Pre_V.Y*fsind[1]*fsind[0]*fsind[2];
	Temp_V.Y += Pre_V.Z*fcosd[1]*fsind[0]*fsind[2];
	Temp_V.Y += Pre_V.Y*fcosd[1]*fcosd[2];
	Temp_V.Y -= Pre_V.Z*fsind[1]*fcosd[2];
	
	Temp_V.Z = -Pre_V.X*fsind[0];
	Temp_V.Z += Pre_V.Y*fsind[1]*fcosd[0];
	Temp_V.Z += Pre_V.Z*fcosd[1]*fcosd[0];
	
	Pre_V.X = Temp_V.X;
	Pre_V.Y = Temp_V.Y;
	Pre_V.Z = Temp_V.Z;

	//----- 位姿计算 -----------------------------------------------------------------------------------	
	// 计算最终控制量
	Pos->Roll = atan2(Pre_V.X,Pre_V.Z)*Gyro_W;                   // 得到度数
	Pos->Pitch = atan2(Pre_V.Y,Pre_V.Z)*Gyro_W;                 // 得到度数
 	Pos->Yaw += Temp_V.Z;

	Pre_V.X = Pre_V.X*(1-Acc_Gyro_Add) +Mpu_6050->Acc_Data[1]*Acc_Gyro_Add;
	Pre_V.Y = Pre_V.Y*(1-Acc_Gyro_Add) +Mpu_6050->Acc_Data[0]*Acc_Gyro_Add;
	Pre_V.Z = Pre_V.Z*(1-Acc_Gyro_Add) +Mpu_6050->Acc_Data[2]*Acc_Gyro_Add;
}

/*****************************@版权 luomin*********************************************************/
